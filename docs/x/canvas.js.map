{"version":3,"sources":["webpack:///./x/canvas.ts","webpack:///webpack/startup"],"names":[],"mappings":"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","file":"canvas.js","sourcesContent":["interface Paragraph {\n  index: number;\n  text: string;\n}\n\nclass XCanvas extends HTMLElement {\n  #canvas!: HTMLCanvasElement;\n  #ctx!: CanvasRenderingContext2D;\n  #shadow!: ShadowRoot;\n  #lineHeight: number = 4; // 行间距\n  #ob: ResizeObserver;\n\n  constructor() {\n    super();\n\n    this.#shadow = this.attachShadow({ mode: \"closed\" });\n\n    const canvas = document.createElement(\"canvas\");\n    this.#canvas = canvas;\n\n    this.#shadow.append(canvas);\n\n    let containerWidth = this.parentElement?.getBoundingClientRect().width || 0;\n\n    this.#ob = new ResizeObserver((entries) => {\n      const entry = entries.find((v) => v.target === this.parentElement);\n\n      if (!entry) return;\n\n      // container width not change\n      if (entry.contentRect.width === containerWidth) return;\n\n      containerWidth = entry.contentRect.width;\n\n      this.render();\n    });\n  }\n\n  private get fontSize() {\n    return parseInt(window.getComputedStyle(this).fontSize);\n  }\n\n  private get fontFamily() {\n    return window.getComputedStyle(this).fontFamily;\n  }\n\n  private privateParse(text: string) {\n    const lines = text.split(\"\\n\");\n\n    const paragraph = [];\n\n    for (const line of lines) {\n      if (!line.length) {\n        paragraph.push(\" \");\n      }\n\n      let start = 0;\n      let end = 1;\n\n      loop: while (start < line.length - 1) {\n        const char = line.slice(start, end);\n\n        const textWidth = this.#ctx.measureText(char).width;\n\n        if (textWidth > this.#canvas.width) {\n          paragraph.push(line.slice(start, end - 1));\n          start = end - 1;\n        } else if (end === line.length) {\n          paragraph.push(char);\n          break loop;\n        }\n\n        end++;\n      }\n    }\n\n    return paragraph;\n  }\n\n  private setCanvasStyle() {\n    // 渲染整行\n    this.#ctx.font = `${this.fontSize}px ${this.fontFamily}`;\n    this.#ctx.fillStyle = \"#000\";\n    this.#ctx.textAlign = \"left\";\n    this.#ctx.textBaseline = \"top\";\n  }\n\n  private render() {\n    this.#canvas.width = this.parentElement?.getBoundingClientRect().width ?? 100;\n    this.setCanvasStyle();\n\n    const text = this.textContent || \"\";\n\n    const indents = text\n      .split(\"\\n\")\n      .filter((v) => /^\\s*$/.test(v) === false)\n      .map((v) => {\n        const match = /^\\s+/.exec(v);\n\n        if (!match || !match.length) return 0;\n\n        return match[0].length;\n      });\n\n    const indent = Math.min(...indents);\n\n    const source = text\n      .trim()\n      .split(\"\\n\")\n      .map((v) => v.replace(new RegExp(`^\\\\s{${indent}}`), \"\"))\n      .join(\"\\n\");\n\n    const paragraphs = this.privateParse(source);\n\n    const height = paragraphs.length * this.fontSize + (paragraphs.length - 1) * this.#lineHeight;\n\n    this.#canvas.height = height;\n    this.style.width = this.#canvas.width + \"px\";\n    this.style.height = this.#canvas.height + \"px\";\n    this.style.display = \"inline-block\";\n\n    this.setCanvasStyle();\n\n    paragraphs.forEach((p, index) => {\n      const x = 0;\n      const y = index * this.fontSize + (index === 0 ? 0 : index * this.#lineHeight);\n      this.#ctx.fillText(p, x, y);\n    });\n  }\n\n  connectedCallback() {\n    const canvas = this.#canvas;\n\n    this.#ob.observe(this.parentElement!);\n\n    const ctx = canvas.getContext(\"2d\") as CanvasRenderingContext2D;\n    this.#ctx = ctx;\n\n    requestAnimationFrame(() => {\n      this.render();\n    });\n  }\n\n  disconnectedCallback() {\n    this.#ob.disconnect();\n  }\n\n  attributeChangedCallback(attrName: string, oldVal: string, newVal: string) {}\n\n  adoptedCallback() {}\n}\n\ncustomElements.define(\"x-canvas\", XCanvas);\n","// startup\n// Load entry module\n// This entry module is referenced by other modules so it can't be inlined\n__webpack_modules__[0]();\n"],"sourceRoot":""}